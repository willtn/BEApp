"use strict";function Item(a){this.selected=!1,angular.extend(this,a)}var app=angular.module("BEApp",["ui.router","ui.keypress","ui.bootstrap","firebase","BEApp.services","BEApp.directives","BEApp.bc"]);app.config(["$stateProvider","$urlRouterProvider","$httpProvider",function(a,b){b.otherwise("/"),a.state("main",{url:"/",templateUrl:"views/main.html",controller:"MainCtrl"}).state("block",{url:"/block/:block_id",templateUrl:"views/block.html",controller:"BlockCtrl"}).state("404",{url:"/404",templateUrl:"404.html"})}]),angular.module("BEApp").controller("MainCtrl",["$scope",function(a){a.awesomeStats=["Block Mined: 200.00","Time Between Blocks: 7.20 (minutes)","Bitcoin Mined: 5,000 BTC","No. of Transactions: 58829","Total Output Volume: 1,176,216.42271571 BTC","Estimated Transaction Volume: 431,868.90068598 BTC"]}]).controller("BlockCtrl",["$scope","$stateParams","$modal","items",function(a,b,c,d){a.block_id=b.block_id,a.block=d.selected,a.block&&(a.tx=a.block.lTx),a.showingId=null,a.showing=!1,a.toogleShowingTx=function(b){a.showingId!=b?(a.showingId=b,a.showing=!0):(a.showingId=null,a.showing=!1)},a.modal=function(a){c.open({templateUrl:"views/tx.html",controller:TxCtrl,resolve:{tx:function(){return a}}})}}]).controller("AppController",["$scope","$stateParams","$state","items","scroll",function(a,b,c,d,e){a.items=d,a.goTo=function(a){d.selectItem(a),c.go("block",{block_id:d.selected.id})},a.goHome=function(){d.deselectItem(),c.go("main")},a.goTop=function(){d.selectItem(0),c.go("block",{block_id:d.selected.id})},a.next=function(){d.next(),c.go("block",{block_id:d.selected.id})},a.prev=function(){d.prev(),c.go("block",{block_id:d.selected.id})},a.handleSpace=function(){e.pageDown()||a.next()},a.$watch("items.selectedIdx",function(a){null!==a&&e.toCurrent()})}]);var TxCtrl=function(a,b,c){a.tx=c,a.ok=function(){b.close()}},services=angular.module("BEApp.services",["firebase"]),bcModule=angular.module("BEApp.bc",[]);bcModule.config(["$httpProvider",function(a){delete a.defaults.headers.common["X-Requested-With"]}]),bcModule.factory("blockchain",["$http","$q","$rootScope",function(a,b,c){function d(a){return g+a+"?format=json&cors=true"}function e(a){var b={hash:a.hash,id:a.block_index,prevHash:a.prev_block,bits:a.bits,relayedBy:a.relayed_by,height:a.height,nTx:a.n_tx,lTx:{}};return a.tx.forEach(function(a){b.lTx[a.tx_index]={hash:a.hash,id:a.tx_index,relayedBy:a.relayed_by,size:a.size,"in":[],out:[]};try{var c=[];a.inputs.forEach(function(d){c.push({addr:d.prev_out.addr,n:d.prev_out.n,id:d.prev_out.tx_index,value:d.prev_out.value}),b.lTx[a.tx_index].in=c})}catch(d){}a.out.forEach(function(c){b.lTx[a.tx_index].out.push({addr:c.addr,n:c.n,value:c.value})})}),b}var f="http://blockchain.info/q/latesthash",g="http://blockchain.info/rawblock/";return{updateBlocks:function(){var a=b.defer();return a.promise},get3Blocks:function(f){var g={blocks:[],prevHash:null},h=b.defer();return a.get(d(f)).success(function(b){g.blocks.push(e(b)),a.get(d(b.prev_block)).success(function(b){g.blocks.push(e(b)),a.get(d(b.prev_block)).success(function(a){g.blocks.push(e(a)),g.prevHash=a.prev_block,h.resolve(g),c.$$phase||c.$apply()})})}),h.promise},getBlock:function(f){var g=b.defer();return a.get(d(f)).success(function(a){g.resolve({block:e(a),prevHash:a.prev_block}),c.$$phase||c.$apply()}),g.promise},getLatestBlocks:function(){var g={blocks:[],latestHash:null,prevHash:null},h=b.defer();return a.get(f).success(function(b){g.latestHash=b,a.get(d(b)).success(function(b){g.blocks.push(e(b)),a.get(d(b.prev_block)).success(function(b){g.blocks.push(e(b)),a.get(d(b.prev_block)).success(function(a){g.blocks.push(e(a)),g.prevHash=a.prev_block,h.resolve(g),c.$$phase||c.$apply()})})})}),h.promise}}}]),services.factory("items",["$http","blockchain","$q",function(a,b,c){var d={all:[],selected:null,selectedIdx:null,prevHash:null,latestHash:null,promise:null,count:0,refreshItems:function(){d.all=[],d.selected=null,d.selectedIdx=null,d.initialFetch()},top:function(){d.selectItem(0)},prev:function(){d.hasPrev()&&d.selectItem(d.selected?d.selectedIdx-1:0)},next:function(){d.hasNext()&&d.selectItem(d.selected?d.selectedIdx+1:0)},hasPrev:function(){return d.selected?d.selectedIdx>0:!0},hasNext:function(){return d.selected?d.selectedIdx<d.all.length-1:!0},selectItem:function(a){d.selected&&(d.selected.selected=!1),d.selected=d.all[a],d.selectedIdx=a,d.selected.selected=!0},deselectItem:function(){d.selected&&(d.selected.selected=!1,d.selected=null,d.selectedIdx=null)},getLatestBlocks:function(){var a=c.defer();return b.getLatestBlocks().then(function(b){d.latestHash=b.latestHash,d.prevHash=b.prevHash,angular.forEach(b.blocks,function(a){var b=new Item(a);d.all.push(b)}),d.all.sort(function(a,b){return a.height<b.height}),a.resolve(!0)}),a.promise},getMoreBlocks:function(){0==d.pendingRequest?(d.pendingRequest=!0,b.get3Blocks(d.prevHash).then(function(a){d.prevHash=a.prevHash;var b=[];angular.forEach(a.blocks,function(a){var c=new Item(a);b.push(c)}),b.sort(function(a,b){return a.height<b.height}),d.all=d.all.concat(b)})):console.log("request pending")},getMore:function(){function a(a){d.prevHash=a.prevHash,d.all.push(new Item(a.block))}var e=c.defer();if(d.promise){var f=d.promise;f.then(function(){b.getBlock(d.prevHash).then(function(b){a(b),e.resolve(!0)})})}else b.getBlock(d.prevHash).then(function(b){a(b),e.resolve(!0)});d.promise=e.promise},initialFetch:function(){d.getLatestBlocks().then(function(){d.getMore(),d.getMore(),d.getMore(),d.getMore()})}};return d.initialFetch(),d}]),services.factory("scroll",["$timeout",function(a){return{pageDown:function(){var a=$(".wrapper.active").height()+60,b=$(window).height(),c=$(".entries").scrollTop(),d=c+b;return a>d?($(".entries").scrollTop(d),!0):!1},toCurrent:function(){a(function(){var a=$(".blocks").scrollTop(),b=$(".block.active").offset().top-60;$(".blocks").animate({scrollTop:a+b},200)},0,!1)}}}]);var directives=angular.module("BEApp.directives",[]);directives.directive("infiniteScroll",function(){return function(a,b,c){var d=b[0];b.bind("scroll",function(){d.scrollTop+d.offsetHeight>=d.scrollHeight&&a.$apply(c.infiniteScroll)})}}),directives.directive("expandPin",function(){}),directives.directive("editableText",function(){return{link:function(a,b){a.readOnly=!0;var c=b.find("a"),d=b.find("input");c.bind("click",function(){a.readOnly=!1,a.$apply(),d[0].focus()}),d.bind("blur",function(){a.readOnly=!0,a.apply()})},replace:!0,transclude:!0,restrict:"E",templateUrl:"views/editable-text.html",scope:{value:"@"}}});