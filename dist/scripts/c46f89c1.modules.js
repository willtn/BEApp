"use strict";function Item(a){this.selected=!1,angular.extend(this,a)}var app=angular.module("BEApp",["ui.router","ui.keypress","ui.bootstrap","firebase","BEApp.services","BEApp.directives","BEApp.bc"]);app.config(["$stateProvider","$urlRouterProvider","$httpProvider",function(a,b){b.otherwise("/"),a.state("main",{url:"/",templateUrl:"views/main.html",controller:"MainCtrl"}).state("block",{url:"/block/:block_id",templateUrl:"views/block.html",controller:"BlockCtrl"}).state("404",{url:"/404",templateUrl:"404.html"})}]),angular.module("BEApp").controller("MainCtrl",["$scope",function(a){a.awesomeStats=["Block Mined: 200.00","Time Between Blocks: 7.20 (minutes)","Bitcoin Mined: 5,000 BTC","No. of Transactions: 58829","Total Output Volume: 1,176,216.42271571 BTC","Estimated Transaction Volume: 431,868.90068598 BTC"]}]).controller("BlockCtrl",["$scope","$stateParams","$modal","items",function(a,b,c,d){a.block_id=b.block_id,a.block=d.selected,a.block&&(a.tx=a.block.lTx),a.showing={showingId:null}}]).controller("AppController",["$scope","$stateParams","$state","items","scroll",function(a,b,c,d,e){a.items=d,a.goTo=function(a){d.selectItem(a),c.go("block",{block_id:d.selected.id})},a.goHome=function(){d.deselectItem(),c.go("main")},a.goTop=function(){d.selectItem(0),c.go("block",{block_id:d.selected.id})},a.next=function(){d.next(),c.go("block",{block_id:d.selected.id})},a.prev=function(){d.prev(),c.go("block",{block_id:d.selected.id})},a.handleSpace=function(){e.pageDown()||a.next()},a.$watch("items.selectedIdx",function(a){null!==a&&e.toCurrent()})}]);var services=angular.module("BEApp.services",["firebase"]),bcModule=angular.module("BEApp.bc",[]);bcModule.config(["$httpProvider",function(a){delete a.defaults.headers.common["X-Requested-With"]}]),bcModule.factory("bcQuery",["$http","$q","$rootScope",function(a,b){function c(a){return h+a+"?format=json&cors=true"}function d(a){return i+a+"?format=json&cors=true"}function e(a){var b={hash:a.hash,id:a.block_index,bits:a.bits,height:a.height,time:a.time,nTx:a.n_tx,lTx:{}};return a.tx.forEach(function(a){b.lTx[a.tx_index]={id:a.tx_index}}),b}function f(a){return{id:a.tx_index,hash:a.hash,relayedBy:a.relayed_by,size:a.size,time:a.time,"in":a.vin_sz,out:a.vout_sz}}var g="http://blockchain.info/q/latesthash",h="http://blockchain.info/rawblock/",i="http://blockchain.info/rawtx/";return{getBlock:function(d){var f=b.defer();return a.get(c(d)).success(function(a){console.log("Received block data: ",a),f.resolve({block:e(a),prevHash:a.prev_block})}),f.promise},getLatestBlocks:function(){var d={blocks:[],latestHash:null,prevHash:null},f=b.defer();return a.get(g).success(function(b){d.latestHash=b,a.get(c(b)).success(function(b){d.blocks.push(e(b)),a.get(c(b.prev_block)).success(function(b){d.blocks.push(e(b)),a.get(c(b.prev_block)).success(function(a){d.blocks.push(e(a)),d.prevHash=a.prev_block,f.resolve(d)})})})}),f.promise},getTrans:function(c){var e=b.defer();return a.get(d(c)).success(function(a){console.log("Received transaction data: ",a),e.resolve(f(a))}),e.promise}}}]),bcModule.factory("bcWebsocket",["$rootScope",function(a){function b(b){console.log("Received data from the websocket: ",b),"block"!=b.op?console.log("Received a wrong type of message: ",b.op):(console.log("Received a block message"),angular.forEach(e,function(d){a.$apply(d(c(b)))}))}function c(a){var b={hash:a.x.hash,id:a.x.blockIndex,bits:a.x.bits,height:a.x.height,time:a.x.time,nTx:a.x.nTx,lTx:{}};return a.x.txIndexes.forEach(function(a){b.lTx[a]={id:a}}),b}var d=new WebSocket("ws://ws.blockchain.info/inv"),e=[];return d.onopen=function(){console.log("Socket has been opened! No subscription yet!")},d.onerror=function(a){console.log("Websocket error: ",a)},d.onmessage=function(a){b(JSON.parse(a.data))},d.onclose=function(){console.log("Socket has been closed!")},{registerCallback:function(a){e.push(a)},subscribeToDemo:function(){d.send('{"op":"ping_block"}'),d.send('{"op":"unconfirmed_sub"}'),console.log("Subscribed to Demo")},subscribeToBlock:function(){d.send('{"op": "blocks_sub"}'),d.send('{"op":"unconfirmed_sub"}'),console.log("Subscribed to Block")}}}]),services.factory("items",["$http","bcQuery","bcWebsocket","$q",function(a,b,c,d){var e={all:[],selected:null,selectedIdx:null,prevHash:null,latestHash:null,promise:null,refreshItems:function(){e.all=[],e.selected=null,e.selectedIdx=null,e.initialFetch()},top:function(){e.selectItem(0)},prev:function(){e.hasPrev()&&e.selectItem(e.selected?e.selectedIdx-1:0)},next:function(){e.hasNext()&&e.selectItem(e.selected?e.selectedIdx+1:0)},hasPrev:function(){return e.selected?e.selectedIdx>0:!0},hasNext:function(){return e.selected?e.selectedIdx<e.all.length-1:!0},selectItem:function(a){e.selected&&(e.selected.selected=!1),e.selected=e.all[a],e.selectedIdx=a,e.selected.selected=!0},deselectItem:function(){e.selected&&(e.selected.selected=!1,e.selected=null,e.selectedIdx=null)},getLatestBlocks:function(){var a=d.defer();return b.getLatestBlocks().then(function(b){!e.latestHash==b.latestHash&&(e.latestHash=b.latestHash),e.prevHash=b.prevHash,angular.forEach(b.blocks,function(a){var b=new Item(a);e.all.push(b)}),e.all.sort(function(a,b){return a.height<b.height}),a.resolve(!0)}),a.promise},openWsListener:function(){function a(a){a.id>e.all[0].id&&(e.latestHash=a.hash,e.all.unshift(new Item(a)),console.log("This just got pushed in :",a))}c.registerCallback(a),c.subscribeToBlock()},getMore:function(){function a(a){e.prevHash=a.prevHash,e.all.push(new Item(a.block))}var c=d.defer();if(e.promise){var f=e.promise;f.then(function(){b.getBlock(e.prevHash).then(function(b){a(b),c.resolve(!0)})})}else b.getBlock(e.prevHash).then(function(b){a(b),c.resolve(!0)});e.promise=c.promise},getTransaction:function(a){var c=d.defer();return b.getTrans(a).then(function(b){e.selected.lTx.hasOwnProperty(a)?e.selected.lTx[a]=b:console.log("The currently selected block does not contain this transaction ",e.selected,a),c.resolve(!0)}),c.promise},initialFetch:function(){e.getLatestBlocks().then(function(){console.log(e.all),e.openWsListener(),e.getMore(),e.getMore(),e.getMore(),e.getMore()})}};return e.initialFetch(),e}]),services.factory("scroll",["$timeout",function(a){return{pageDown:function(){var a=$(".wrapper.active").height()+60,b=$(window).height(),c=$(".entries").scrollTop(),d=c+b;return a>d?($(".entries").scrollTop(d),!0):!1},toCurrent:function(){a(function(){var a=$(".blocks").scrollTop(),b=$(".block.active").offset().top-60;$(".blocks").animate({scrollTop:a+b},200)},0,!1)}}}]);var directives=angular.module("BEApp.directives",[]);directives.directive("infiniteScroll",function(){return function(a,b,c){var d=b[0];b.bind("scroll",function(){d.scrollTop+d.offsetHeight>=d.scrollHeight&&a.$apply(c.infiniteScroll)})}}),directives.directive("expandPin",["items",function(a){return{restrict:"E",scope:{obj:"=",header:"=",showing:"="},templateUrl:"views/expand-pin.html",link:function(b){console.log("link function called"),b.expandOn=b.showing.showingId==b.obj.id?!0:!1,b.fetched=b.obj.hasOwnProperty("time")?!0:!1,b.toogleExpand=function(){var c=b.obj.id;b.fetched?b.expandOn=!b.expandOn:(console.log("Fetch called",c,a.selected.lTx[c]),a.getTransaction(c).then(function(){console.log("Fetched finished",a.selected.lTx[c]),b.fetched=!0,b.showing.showingId=c}))},b.attrList=[];for(var c in b.obj)b.obj.hasOwnProperty(c)&&"id"!=c&&"hash"!=c&&"$$hashKey"!=c&&b.attrList.push(c)}}}]),directives.directive("editableText",function(){return{link:function(a,b){a.readOnly=!0;b.find("input");a.toogleEdit=function(){a.readOnly=!a.readOnly}},restrict:"E",templateUrl:"views/editable-text.html",scope:{value:"=ngModel"}}});